const servers = await fetchServers({ episodeId: ep.id })
// Calls: api.hianime.episodeServers
// Backend: src/convex/hianime.ts ‚Üí episodeServers action
// Returns: { sub: [{id, name}], dub: [{id, name}] }

// Normalize server names (remove spaces, hyphens, lowercase)
const normalize = (s: string) => (s || "").toLowerCase().replace(/[\s\-_]/g, "");
const isHD2Strict = (name: string) => 
  /\bhd[-_\s]*2\b/i.test(name) || normalize(name).includes("hd2");

// Find HD-2 in SUB servers first
const hd2Sub = findHD2(subList);
// If not found, try DUB servers
const hd2Dub = findHD2(dubList);
// Pick the first available
const chosen = hd2Sub || hd2Dub;

const sources = await fetchSources({ serverId: chosen.id })
// Calls: api.hianime.episodeSources
// Backend: src/convex/hianime.ts ‚Üí episodeSources action
// Returns: { sources: [{file: "url", type: "hls"}], tracks: [{file, label}] }

// Prefer HLS (.m3u8) sources
const hls = sources.sources.find(s => 
  (s.type && s.type.toLowerCase().includes("hls")) || 
  /\.m3u8($|\?)/i.test(s.file)
) || null;

const first = hls || sources.sources[0];
// The URL being played: first.file

console.log("üé¨ Playing URL:", first.file);
console.log("üé¨ Source type:", first.type);
console.log("üé¨ Is HLS:", /\.m3u8($|\?)/i.test(first.file));

setVideoSource(first.file);  // ‚Üê THIS IS THE URL BEING PLAYED
setVideoTracks(safeTracks);
setVideoTitle(`${selected?.title} - Episode ${ep.number} ‚Ä¢ ${categoryUsed.toUpperCase()}`);

// Receives: source={videoSource} (the URL from step 6)
// Detects if HLS: /\.m3u8($|\?)/i.test(source)

// If HLS:
// - Dynamically loads hls.js from CDN
// - Creates HLS instance with config:
//   - fetchSetup: referrerPolicy: "no-referrer"
//   - xhrSetup: withCredentials = false
// - Attaches to video element
// - Loads source: hls.loadSource(source)

// If not HLS:
// - Sets video.src = source directly