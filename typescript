// Original M3U8 URL
const originalUrl = "https://megacloud.blog/stream/file.m3u8";

// Proxied URL
const proxiedUrl = `${convexSiteUrl}/proxy?url=${encodeURIComponent(originalUrl)}`;

// Same for subtitles
const proxiedTracks = tracks.map(track => ({
  ...track,
  file: `${convexSiteUrl}/proxy?url=${encodeURIComponent(track.file)}`
}));

http.route({
  path: "/proxy",
  method: "GET",
  handler: httpAction(async (ctx, request) => {
    const url = new URL(request.url);
    const targetUrl = url.searchParams.get("url");
    
    // Fetch the external resource server-side
    const response = await fetch(targetUrl);
    const content = await response.arrayBuffer();
    
    // Return with CORS headers allowing browser access
    return new Response(content, {
      headers: {
        "Content-Type": response.headers.get("Content-Type") || "application/octet-stream",
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "GET, OPTIONS",
        "Cache-Control": "public, max-age=3600"
      }
    });
  })
})

// HLS.js loads the proxied M3U8
hls.loadSource(proxiedUrl); // No CORS error!

// Subtitle tracks use proxied URLs
<track src={proxiedTrackUrl} /> // No CORS error!