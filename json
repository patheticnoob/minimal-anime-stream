[
  {"tool_code": "EDIT_FILE", "file_path": "src/themes/nothing/pages/Watch.tsx", "content": "// ... keep existing code for imports and component definition\n\nexport default function NothingWatch() {\n  const { animeId } = useParams<{ animeId: string }>();\n  const navigate = useNavigate();\n  const { isAuthenticated } = useAuth();\n\n  const fetchEpisodes = useAction(api.hianime.episodes);\n  const fetchServers = useAction(api.hianime.episodeServers);\n  const fetchSources = useAction(api.hianime.episodeSources);\n  const fetchBroadcastInfo = useAction(api.jikan.searchBroadcast);\n\n  const [anime, setAnime] = useState<AnimeDetail | null>(null);\n  const [episodes, setEpisodes] = useState<Episode[]>([]);\n  const [episodesWithProgress, setEpisodesWithProgress] = useState<Episode[]>([]);\n  const [episodesLoading, setEpisodesLoading] = useState(true);\n  const [videoSource, setVideoSource] = useState<string | null>(null);\n  const [videoTitle, setVideoTitle] = useState<string>(\"\");\n  const [videoTracks, setVideoTracks] = useState<Array<{ file: string; label: string; kind?: string }>>([]);\n  const [videoIntro, setVideoIntro] = useState<{ start: number; end: number } | null>(null);\n  const [videoOutro, setVideoOutro] = useState<{ start: number; end: number } | null>(null);\n  const [currentEpisodeIndex, setCurrentEpisodeIndex] = useState<number | null>(null);\n  const [currentEpisodeData, setCurrentEpisodeData] = useState<Episode | null>(null);\n  const [currentAnimeInfo, setCurrentAnimeInfo] = useState<AnimePlaybackInfo | null>(null);\n  const [broadcastInfo, setBroadcastInfo] = useState<BroadcastInfo | null>(null);\n  const [isBroadcastLoading, setIsBroadcastLoading] = useState(false);\n\n  const saveProgress = useMutation(api.watchProgress.saveProgress);\n  const addToWatchlist = useMutation(api.watchlist.addToWatchlist);\n  const removeFromWatchlist = useMutation(api.watchlist.removeFromWatchlist);\n  \n  const isInWatchlist = useQuery(\n    api.watchlist.isInWatchlist,\n    animeId ? { animeId } : \"skip\"\n  );\n\n  const animeProgress = useQuery(\n    api.watchProgress.getProgress,\n    animeId ? { animeId } : \"skip\"\n  );\n\n  // Load anime data from URL params or localStorage\n  useEffect(() => {\n    if (!animeId) {\n      navigate(\"/\");\n      return;\n    }\n\n    const storedAnime = localStorage.getItem(`anime_${animeId}`);\n    if (storedAnime) {\n      try {\n        const animeData = JSON.parse(storedAnime);\n        setAnime(animeData);\n      } catch (err) {\n        console.error(\"Failed to parse stored anime data:\", err);\n      }\n    }\n\n    setEpisodesLoading(true);\n    fetchEpisodes({ dataId: animeId })\n      .then((eps) => {\n        const normalizedEpisodes = (eps as Episode[]).map((ep) => ({\n          ...ep,\n          number: normalizeEpisodeNumber(ep.number),\n        }));\n        setEpisodes(normalizedEpisodes);\n      })\n      .catch((err) => {\n        const msg = err instanceof Error ? err.message : \"Failed to load episodes.\";\n        toast.error(msg);\n      })\n      .finally(() => setEpisodesLoading(false));\n\n    if (storedAnime) {\n      const animeData = JSON.parse(storedAnime);\n      if (animeData.title) {\n        setIsBroadcastLoading(true);\n        fetchBroadcastInfo({ title: animeData.title })\n          .then((result) => {\n            const status = result?.status ?? null;\n            if (status !== \"airing\" && status !== \"upcoming\") {\n              setBroadcastInfo(null);\n              return;\n            }\n\n            const broadcast = result?.broadcast;\n            if (!broadcast) return;\n\n            const summaryParts: string[] = [];\n            if (broadcast.string) {\n              summaryParts.push(broadcast.string);\n            } else {\n              if (broadcast.day) summaryParts.push(broadcast.day);\n              if (broadcast.time) summaryParts.push(broadcast.time);\n            }\n\n            let summary = summaryParts.join(\" • \");\n            if (broadcast.timezone) {\n              summary = summary ? `${summary} (${broadcast.timezone})` : broadcast.timezone;\n            }\n\n            const info: BroadcastInfo = {\n              summary: summary || null,\n              day: broadcast.day ?? null,\n              time: broadcast.time ?? null,\n              timezone: broadcast.timezone ?? null,\n              status,\n            };\n\n            if (info.summary || info.day || info.time || info.timezone) {\n              setBroadcastInfo(info);\n            }\n          })\n          .catch(() => {\n            setBroadcastInfo(null);\n          })\n          .finally(() => setIsBroadcastLoading(false));\n      }\n    }\n  }, [animeId, fetchEpisodes, fetchBroadcastInfo, navigate]);\n\n  // Merge episodes with progress data\n  useEffect(() => {\n    if (!animeProgress || episodes.length === 0) {\n      setEpisodesWithProgress(episodes);\n      return;\n    }\n\n    const merged = episodes.map((ep) => {\n      if (ep.id === animeProgress.episodeId) {\n        return {\n          ...ep,\n          currentTime: animeProgress.currentTime,\n          duration: animeProgress.duration,\n        };\n      }\n      return ep;\n    });\n    setEpisodesWithProgress(merged);\n  }, [episodes, animeProgress]);\n\n  const handleToggleWatchlist = async () => {\n    if (!isAuthenticated) {\n      toast.error(\"Please sign in to use watchlist\");\n      navigate(\"/auth\");\n      return;\n    }\n\n    if (!animeId) return;\n\n    try {\n      if (isInWatchlist) {\n        await removeFromWatchlist({ animeId });\n        toast.success(\"Removed from watchlist\");\n      } else {\n        await addToWatchlist({\n          animeId,\n          animeTitle: anime?.title || \"\",\n          animeImage: anime?.image,\n          animeType: anime?.type,\n          language: anime?.language,\n        });\n        toast.success(\"Added to watchlist\");\n      }\n    } catch (err) {\n      const msg = err instanceof Error ? err.message : \"Failed to update watchlist\";\n      toast.error(msg);\n    }\n  };\n\n  const playEpisode = async (episode: Episode) => {\n    if (!isAuthenticated) {\n      toast.error(\"Please sign in to watch\");\n      navigate(\"/auth\");\n      return;\n    }\n\n    if (!animeId) {\n      toast.error(\"Invalid anime selection\");\n      return;\n    }\n\n    const normalizedEpisodeNumber = normalizeEpisodeNumber(episode.number);\n    const normalizedEpisode: Episode = { ...episode, number: normalizedEpisodeNumber };\n\n    const animeInfo: AnimePlaybackInfo = {\n      animeId,\n      title: anime?.title || \"\",\n      image: anime?.image ?? null,\n      type: anime?.type,\n      language: anime?.language,\n    };\n    setCurrentAnimeInfo(animeInfo);\n    setCurrentEpisodeData(normalizedEpisode);\n\n    setVideoSource(null);\n    setVideoIntro(null);\n    setVideoOutro(null);\n\n    toast(\"Loading video...\");\n\n    try {\n      const servers = await fetchServers({ episodeId: episode.id });\n      const serverData = servers as { sub: Array<{ id: string; name: string }>; dub: Array<{ id: string; name: string }> };\n\n      const subServers = serverData.sub || [];\n      const preferredServer = subServers.find(s => s.name === \"HD-2\") || subServers[0];\n\n      if (!preferredServer) {\n        toast.error(\"No streaming servers available\");\n        return;\n      }\n\n      const sources = await fetchSources({ serverId: preferredServer.id });\n      const sourcesData = sources as {\n        sources: Array<{ file: string; type: string }>;\n        tracks?: Array<{ file: string; label: string; kind?: string }>;\n        intro?: { start: number; end: number };\n        outro?: { start: number; end: number };\n      };\n\n      if (sourcesData.sources && sourcesData.sources.length > 0) {\n        const m3u8Source = sourcesData.sources.find(s => s.file.includes(\".m3u8\"));\n        const originalUrl = m3u8Source?.file || sourcesData.sources[0].file;\n\n        const raw = import.meta.env.VITE_CONVEX_URL as string;\n        let base = raw;\n        try {\n          const u = new URL(raw);\n          const hostname = u.hostname.replace(\".convex.cloud\", \".convex.site\");\n          base = `${u.protocol}//${hostname}`;\n        } catch {\n          base = raw.replace(\"convex.cloud\", \"convex.site\");\n        }\n        base = base.replace(\"/.well-known/convex.json\", \"\").replace(/\\/$/, \"\");\n\n        const proxiedUrl = `${base}/proxy?url=${encodeURIComponent(originalUrl)}`;\n        const proxiedTracks = (sourcesData.tracks || []).map((t) => ({\n          ...t,\n          kind: t.kind || \"subtitles\",\n          file: `${base}/proxy?url=${encodeURIComponent(t.file)}`,\n        }));\n\n        setVideoSource(proxiedUrl);\n        setVideoTitle(`${anime?.title} - Episode ${normalizedEpisodeNumber}`);\n        setVideoTracks(proxiedTracks);\n        setVideoIntro(sourcesData.intro || null);\n        setVideoOutro(sourcesData.outro || null);\n\n        const idx = episodes.findIndex((e) => e.id === episode.id);\n        if (idx !== -1) setCurrentEpisodeIndex(idx);\n\n        toast.success(`Playing Episode ${normalizedEpisodeNumber}`);\n      } else {\n        toast.error(\"No video sources available\");\n      }\n    } catch (err) {\n      const msg = err instanceof Error ? err.message : \"Failed to load video\";\n      toast.error(msg);\n    }\n  };\n\n  const handleProgressUpdate = useCallback(async (currentTime: number, duration: number) => {\n    if (!isAuthenticated) return;\n    if (!currentEpisodeData || !currentAnimeInfo) return;\n    if (!duration || duration <= 0) return;\n\n    const episodeNumberForProgress = normalizeEpisodeNumber(currentEpisodeData.number);\n\n    try {\n      await saveProgress({\n        animeId: currentAnimeInfo.animeId,\n        animeTitle: currentAnimeInfo.title,\n        animeImage: currentAnimeInfo.image ?? null,\n        episodeId: currentEpisodeData.id,\n        episodeNumber: episodeNumberForProgress,\n        currentTime: Math.floor(currentTime),\n        duration: Math.floor(duration),\n      });\n    } catch (err) {\n      console.error(\"❌ Failed to save progress:\", err);\n    }\n  }, [isAuthenticated, currentEpisodeData, currentAnimeInfo, saveProgress]);\n\n  const broadcastDetails = (() => {\n    if (!broadcastInfo?.day || !broadcastInfo?.time || !broadcastInfo?.timezone) {\n      return null;\n    }\n    const normalizedDay = broadcastInfo.day.toLowerCase().replace(/s$/, \"\");\n    const dayMap: Record<string, number> = {\n      monday: 1,\n      tuesday: 2,\n      wednesday: 3,\n      thursday: 4,\n      friday: 5,\n      saturday: 6,\n      sunday: 7,\n    };\n    const targetWeekday = dayMap[normalizedDay];\n    if (!targetWeekday) return null;\n    const [hourStr, minuteStr = \"0\"] = broadcastInfo.time.split(\":\");\n    const hour = Number(hourStr);\n    const minute = Number(minuteStr);\n    if (!Number.isFinite(hour) || !Number.isFinite(minute)) return null;\n    const zone = broadcastInfo.timezone || \"UTC\";\n    const nowInZone = DateTime.now().setZone(zone);\n    if (!nowInZone.isValid) return null;\n    let next = nowInZone\n      .startOf(\"day\")\n      .plus({ days: (targetWeekday - nowInZone.weekday + 7) % 7 })\n      .set({ hour, minute, second: 0, millisecond: 0 });\n    if (next <= nowInZone) {\n      next = next.plus({ weeks: 1 });\n    }\n    const nextInIST = next.setZone(\"Asia/Kolkata\");\n    if (!nextInIST.isValid) return null;\n    const nowInIST = DateTime.now().setZone(\"Asia/Kolkata\");\n    const diff = nextInIST.diff(nowInIST, [\"days\", \"hours\"]).shiftTo(\"days\", \"hours\");\n    const remainingDays = Math.max(0, Math.floor(diff.days ?? 0));\n    const remainingHours = Math.max(0, Math.floor(diff.hours ?? 0));\n    return {\n      istLabel: `${nextInIST.weekdayLong} at ${nextInIST.toFormat(\"hh:mm a\")} IST`,\n      countdown: `${remainingDays} day${remainingDays === 1 ? \"\" : \"s\"} ${remainingHours} hour${remainingHours === 1 ? \"\" : \"s\"} remaining`,\n    };\n  })();\n\n  const isBroadcastActive =\n    broadcastInfo?.status === \"airing\" || broadcastInfo?.status === \"upcoming\";\n  const shouldShowBroadcast = isBroadcastLoading || isBroadcastActive;\n\n  if (episodesLoading) {\n    return <FullscreenLoader label=\"Loading anime...\" subLabel=\"Fetching episodes\" />;\n  }\n\n  return (\n    <div data-theme=\"nothing\" className=\"min-h-screen bg-[#F5F7FB] text-[#050814]\">\n      {/* Header */}\n      <header className=\"fixed top-0 left-0 right-0 z-50 bg-white/80 backdrop-blur-lg border-b border-black/5\">\n        <div className=\"max-w-[2000px] mx-auto px-6 py-4 flex items-center gap-4\">\n          <button\n            onClick={() => navigate(\"/\")}\n            className=\"flex items-center gap-2 text-gray-500 hover:text-black transition-colors group\"\n          >\n            <div className=\"p-2 rounded-full bg-black/5 group-hover:bg-black/10 transition-colors\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </div>\n            <span className=\"text-sm font-medium tracking-widest uppercase\">Back</span>\n          </button>\n          <div className=\"flex-1\">\n            <h1 className=\"text-xl font-bold truncate tracking-wide text-[#050814]\">{anime?.title || \"Loading...\"}</h1>\n          </div>\n          <Button\n            onClick={handleToggleWatchlist}\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"gap-2 border-black/10 hover:bg-black/5 text-[#050814]\"\n          >\n            {isInWatchlist ? (\n              <>\n                <Check className=\"h-4 w-4 text-[#ff4d4f]\" />\n                <span className=\"tracking-wider\">IN WATCHLIST</span>\n              </>\n            ) : (\n              <>\n                <Plus className=\"h-4 w-4\" />\n                <span className=\"tracking-wider\">ADD TO LIST</span>\n              </>\n            )}\n          </Button>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"pt-32 md:pt-24 px-4 md:px-6 pb-10 max-w-[2000px] mx-auto\">\n        <div className=\"grid grid-cols-1 lg:grid-cols-[1fr_400px] gap-8\">\n          {/* Left: Video Player */}\n          <div className=\"space-y-8 md:mt-0\">\n            {videoSource && currentEpisodeData ? (\n              <NothingVideoPlayerV2\n                source={videoSource}\n                title={videoTitle}\n                tracks={videoTracks}\n                intro={videoIntro}\n                outro={videoOutro}\n                onClose={() => setVideoSource(null)}\n                resumeFrom={\n                  animeProgress &&\n                  currentEpisodeData &&\n                  animeProgress.episodeId === currentEpisodeData.id &&\n                  animeProgress.currentTime > 0 &&\n                  animeProgress.duration > 0\n                    ? animeProgress.currentTime\n                    : 0\n                }\n                onProgressUpdate={handleProgressUpdate}\n                onNext={() => {\n                  if (currentEpisodeIndex === null) return;\n                  const next = episodes[currentEpisodeIndex + 1];\n                  if (next) playEpisode(next);\n                }}\n                nextTitle={\n                  currentEpisodeIndex !== null && episodes[currentEpisodeIndex + 1]\n                    ? `${anime?.title} • Ep ${episodes[currentEpisodeIndex + 1].number ?? \"?\"}`\n                    : undefined\n                }\n              />\n            ) : (\n              <div className=\"nothing-player-shell aspect-video flex items-center justify-center bg-white rounded-[32px] border border-black/5 relative overflow-hidden shadow-sm\">\n                <div className=\"absolute inset-0 bg-[url('/assets/noise.png')] opacity-5 pointer-events-none\"></div>\n                <div className=\"nothing-player-empty text-center z-10\">\n                  <div className=\"nothing-player-icon mb-6 inline-flex p-6 rounded-full bg-black/5 border border-black/5\">\n                    <ImageIcon className=\"h-12 w-12 text-black/20\" />\n                  </div>\n                  <p className=\"text-[#ff4d4f] text-xs tracking-[0.4em] uppercase font-bold mb-2\">Select Content</p>\n                  <p className=\"text-[#050814] text-2xl font-bold tracking-tight\">Choose an episode to start</p>\n                </div>\n              </div>\n            )}\n\n            {/* Anime Info */}\n            <div className=\"bg-white border border-black/5 rounded-[24px] p-8 relative overflow-hidden shadow-sm\">\n              <div className=\"absolute top-0 right-0 p-6 opacity-[0.03] pointer-events-none\">\n                <h1 className=\"text-9xl font-bold tracking-tighter text-black\">NOTHING</h1>\n              </div>\n              \n              <div className=\"flex flex-col md:flex-row gap-8 relative z-10\">\n                {anime?.image && (\n                  <div className=\"shrink-0\">\n                    <img\n                      src={anime.image}\n                      alt={anime.title}\n                      className=\"w-40 h-60 object-cover rounded-2xl shadow-lg border border-black/5\"\n                    />\n                  </div>\n                )}\n                <div className=\"flex-1 space-y-6\">\n                  <div>\n                    <h2 className=\"text-4xl font-bold mb-3 tracking-tight leading-tight text-[#050814]\">{anime?.title || \"Unknown Title\"}</h2>\n                    <div className=\"flex items-center gap-3 flex-wrap\">\n                      {anime?.type && (\n                        <span className=\"px-3 py-1 rounded-full border border-black/10 text-xs font-medium tracking-wider uppercase text-black/60\">\n                          {anime.type}\n                        </span>\n                      )}\n                      {anime?.language?.sub && (\n                        <span className=\"px-3 py-1 rounded-full bg-black/5 text-xs font-medium tracking-wider uppercase text-black/80\">\n                          SUB\n                        </span>\n                      )}\n                      {anime?.language?.dub && (\n                        <span className=\"px-3 py-1 rounded-full bg-black/5 text-xs font-medium tracking-wider uppercase text-black/80\">\n                          DUB\n                        </span>\n                      )}\n                      {episodes.length > 0 && (\n                        <span className=\"px-3 py-1 rounded-full border border-[#ff4d4f]/30 text-[#ff4d4f] text-xs font-medium tracking-wider uppercase\">\n                          {episodes.length} Episodes\n                        </span>\n                      )}\n                    </div>\n                  </div>\n\n                  {episodes.length > 0 && (\n                    <Button\n                      onClick={() => playEpisode(episodes[0])}\n                      className=\"nothing-play-cta h-14 px-8 rounded-full bg-[#ff4d4f] text-white hover:bg-[#ff4d4f]/90 transition-all text-base font-bold tracking-wide shadow-lg shadow-[#ff4d4f]/20\"\n                      disabled={episodes.length === 0}\n                    >\n                      <Play className=\"mr-2 h-5 w-5 fill-white\" />\n                      START WATCHING\n                    </Button>\n                  )}\n\n                  {shouldShowBroadcast && (\n                    <div className=\"flex items-start gap-4 p-4 rounded-xl bg-black/5 border border-black/5 max-w-md\">\n                      <div className=\"p-2 rounded-full bg-[#ff4d4f]/10 text-[#ff4d4f]\">\n                        <Clock3 className=\"h-5 w-5\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        {isBroadcastLoading ? (\n                          <span className=\"text-sm text-black/60\">Syncing broadcast data...</span>\n                        ) : (\n                          <div className=\"space-y-1\">\n                            <span className=\"block text-xs font-bold tracking-[0.2em] text-black/40 uppercase\">\n                              Next Broadcast\n                            </span>\n                            <span className=\"block font-medium text-[#050814]\">\n                              {broadcastDetails?.istLabel ?? broadcastInfo?.summary ?? \"TBA\"}\n                            </span>\n                            {broadcastDetails?.countdown && (\n                              <span className=\"block text-sm text-[#ff4d4f]\">\n                                {broadcastDetails.countdown}\n                              </span>\n                            )}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Right: Episode List */}\n          <div className=\"bg-white border border-black/5 rounded-[24px] p-6 h-fit max-h-[calc(100vh-120px)] overflow-y-auto flex flex-col shadow-sm\">\n            <div className=\"flex items-center justify-between mb-6 sticky top-0 bg-white z-10 py-2\">\n              <h3 className=\"text-sm font-bold uppercase tracking-[0.2em] text-black/40\">Episodes</h3>\n              <span className=\"text-xs font-mono text-black/30\">{episodes.length} TOTAL</span>\n            </div>\n            \n            {episodesWithProgress.length > 0 ? (\n              <div className=\"space-y-3\">\n                {episodesWithProgress.map((ep) => {\n                  const progressPercentage =\n                    ep.currentTime && ep.duration ? (ep.currentTime / ep.duration) * 100 : 0;\n                  const isCurrentEpisode = currentEpisodeData?.id === ep.id;\n\n                  return (\n                    <button\n                      key={ep.id}\n                      onClick={() => playEpisode(ep)}\n                      className={`group relative w-full text-left p-4 rounded-xl border transition-all duration-300 ${\n                        isCurrentEpisode \n                          ? \"bg-[#ff4d4f]/5 border-[#ff4d4f] shadow-[0_0_20px_rgba(255,77,79,0.1)]\" \n                          : \"bg-black/5 border-transparent hover:bg-black/10 hover:border-black/10\"\n                      }`}\n                    >\n                      <div className=\"flex items-center gap-4 relative z-10\">\n                        <div className={`flex items-center justify-center w-10 h-10 rounded-full font-mono text-sm font-bold ${\n                          isCurrentEpisode ? \"bg-[#ff4d4f] text-white\" : \"bg-white text-black/40 group-hover:text-black shadow-sm\"\n                        }`}>\n                          {ep.number ?? \"#\"}\n                        </div>\n                        \n                        <div className=\"flex-1 min-w-0\">\n                          <p className={`font-medium truncate ${isCurrentEpisode ? \"text-[#ff4d4f]\" : \"text-[#050814] group-hover:text-black\"}`}>\n                            {ep.title || `Episode ${ep.number ?? \"?\"}`}\n                          </p>\n                          <p className=\"text-xs text-black/40 font-mono mt-0.5\">\n                            EP {ep.number ?? \"?\"}\n                          </p>\n                        </div>\n\n                        {isCurrentEpisode ? (\n                          <div className=\"w-2 h-2 rounded-full bg-[#ff4d4f] animate-pulse\" />\n                        ) : (\n                          <Play className=\"h-4 w-4 text-black/0 group-hover:text-black/40 transition-all transform translate-x-2 group-hover:translate-x-0\" />\n                        )}\n                      </div>\n\n                      {progressPercentage > 0 && (\n                        <div className=\"absolute inset-x-4 bottom-1 pointer-events-none\">\n                          <div className=\"h-1 rounded-full bg-[#ff4d4f]/15 overflow-hidden\">\n                            <div\n                              className=\"h-full rounded-full bg-[#ff4d4f] transition-all\"\n                              style={{ width: `${Math.min(progressPercentage, 100)}%` }}\n                            />\n                          </div>\n                        </div>\n                      )}\n                    </button>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"flex flex-col items-center justify-center py-12 text-black/20\">\n                <div className=\"w-12 h-12 rounded-full border border-dashed border-black/10 flex items-center justify-center mb-4\">\n                  <Film className=\"h-6 w-6\" />\n                </div>\n                <p className=\"text-sm tracking-widest uppercase\">No episodes found</p>\n              </div>\n            )}\n          </div>\n        </div>\n      </main>\n    </div>\n  );\n}\n"}
]
